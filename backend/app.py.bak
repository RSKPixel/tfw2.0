@app.exception_handler(404)
def not_found_handler(request: Request, exc):
    return Response(content="Custom 404: Resource not found", status_code=404)


@app.get("/symbols")
def get_symbols():

    symbols = fetch_symbols()

    return JSONResponse(content=list(symbols["symbol"]), status_code=200)


@app.get("/ohlcv")
def get_ohlcv(
    symbol: str = "NIFTY-I",
    start_date: str = (datetime.now() - timedelta(days=365)).strftime("%Y-%m-%d"),
    end_date: str = datetime.now().strftime("%Y-%m-%d"),
    timeframe: str = "1day",
):
    df = fetch_ohlcv(symbol, start_date, end_date, timeframe)
    data = json.loads(df.to_json(orient="records", date_format="iso"))

    return JSONResponse(content=data, status_code=200)


@app.get("/ohlcv-ta")
def get_ohlcv_ta(
    symbol: str = "NIFTY-I",
    start_date: str = (datetime.now() - timedelta(days=365)).strftime("%Y-%m-%d"),
    end_date: str = datetime.now().strftime("%Y-%m-%d"),
    timeframe: str = "1day",
):
    df = fetch_ohlcv_ta(symbol, start_date, end_date, timeframe)
    data = json.loads(df.to_json(orient="records", date_format="iso"))

    return JSONResponse(content=data, status_code=200)


@app.get("/eod")
def fetch_eod(
    symbol: str = "NIFTY-I",
    start_date: str = (datetime.now() - timedelta(days=365)).strftime("%Y-%m-%d"),
    end_date: str = datetime.now().strftime("%Y-%m-%d"),
):
    kiteapi = config.kite_connect()
    data = eod(symbol, start_date, end_date, kiteapi)
    return JSONResponse(content=data, status_code=200)


@app.get("/instruments")
def get_instruments():
    kiteapi = config.kite_connect()
    instruments = fetch_instruments(kiteapi)
    return JSONResponse(content=instruments, status_code=200)
